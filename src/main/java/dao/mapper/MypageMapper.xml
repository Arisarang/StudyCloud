<?xml version="1.0" encoding="UTF-8"?>
<!-- 마이바티스 3 Mapper DTD -->
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dao.face.MypageDao">

    <!-- 회원정보 수정 -->
    <update id = "userUpdate" parameterType="member">
        update MEMBER
        set member_pw = #{memberPw}, member_name = #{memberName}, member_phone = #{memberPhone}, 
       		member_email = #{memberEmail}, member_nick = #{memberNick}
        where member_no = #{memberNo}
    </update>
    
	<!-- 프로필 사진 가져오기 -->
	<select id="selectProfile" resultType="dto.FileUpload" parameterType="int">
		SELECT F.* FROM member M, fileupload F
			WHERE m.member_no = f.member_no
			and m.member_no = #{memberNo} 
			and fboard_no is null and mtboard_no is null and mntboard_no is null and sroom_no is null
	</select>		
	
    <!-- 회원 탈퇴 -->
	<update id="withdrawal" parameterType="member">
		update member
		set withdrawal = 'Y' 
		where member_no = #{memberNo}
	</update>
	
	<!-- 탈퇴시 비밀번호 확인  -->
	<select id="checkPw" parameterType="member" resultType="int">
		select count(*) from member where member_no = #{memberNo} and member_pw = #{memberPw} 
	</select>
	
    <!-- 프로필 사진 생성 -->
	<insert id="insertProfile" parameterType="map">
		INSERT INTO fileUpload (fileUpload_no, member_no, fileUpload_ori, fileUpload_stor )
		VALUES (fileUpload_seq.nextval, #{memberNo}, #{fileUploadOri}, #{fileUploadStor})
	</insert>
	
	<!-- 프로필 사진 업데이트 -->
	<select id="updateProfile" parameterType="dto.FileUpload">
		update fileUpload
			set fileUpload_ori = #{fileUploadOri},
			fileUpload_stor = #{fileUploadStor}
	</select>		
	
	<!-- 예약 목록 조회 -->
	   <select id='reservationlist' resultType='hashmap'>
        select * 
		 from studyroom s
		 join reservation r on s.sroom_no = r.sroom_no
		 join member m on r.member_no = m.member_no
		 join fileupload f on s.sroom_no = f.sroom_no
		where m.member_id = #{id} 
		order by r.reserve_no desc
   		</select>

	<!-- 쪽지함 조회 -->
		<select id='messagelist' resultType='hashmap'>
		select *
		from message s
		join member m on s.member_no = m.member_no and m.withdrawal = 'N'
		join fileupload f on s.member_no = f.member_no
		where m.member_id = #{id} 
		and f.fboard_no is null 
        and f.mtboard_no is null 
        and f.mntboard_no is null 
        and f.mboard_no is null 
        and f.sroom_no is null
		order by s.member_no desc
   		</select>
   		
   	<!-- 위시리스트 조회 -->
   		<select id='wishlist' resultType='hashmap'>
		select *
		from studymark sm
		join member m on sm.member_no = m.member_no and m.withdrawal = 'N'
        left join reservation r on m.member_no = r.member_no
        left join studyroom sr on r.sroom_no = sr.sroom_no
		left join fileupload f on sr.sroom_no = f.sroom_no
        left join studyboard s on sm.member_no = s.member_no
        left join mtmark mm on sm.member_no = mm.member_no
        left join mtboard mb on sm.member_no = mb.member_no
        left join sroommark rm on sm.member_no = rm.member_no


        order by s.member_no desc
   		</select>


	<!-- 마이스터디 조회 -->
	<select id='mystudy' resultType='hashmap'>
		select *
        from member m
		left join applymnt a on m.member_no = a.member_no
		left join fileupload f on a.member_no = f.member_no
		left join mtboard mt on a.member_no = mt.member_no
		left  join studyboard sb on a.member_no = sb.member_no
		 where m.withdrawal = 'N'
		and f.fboard_no is null
		and f.mtboard_no is null
		and f.mntboard_no is null and f.mboard_no is null and f.sroom_no is null
		order by a.member_no desc
	</select>
   		


</mapper>