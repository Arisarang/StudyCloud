<?xml version="1.0" encoding="UTF-8"?>

<!-- 마이바티스 3 Mapper DTD -->
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="dao.face.MboardDao">

	<select id="selectCntAll" resultType="int">
		SELECT count(*) FROM mboard
	</select>
	
	<select id="selectMboardHash" resultType="hashMap" parameterType="util.Paging">
		SELECT * FROM (
			SELECT rownum rnum, B.*  FROM (
				SELECT b.mboard_no, b.member_no, b.mboard_title, b.mboard_content, b.mboard_date, b.mboard_hit, b.mboard_cmtcnt, b.mboard_likecnt
					,m.member_id, m.member_nick 
				FROM mboard b
				JOIN member m ON ( b.member_no = m.member_no ) ORDER BY b.mboard_no DESC
			) B
		) MBOARD
	 	WHERE rnum between #{startNo } AND #{endNo }
	</select>

	<update id="updateHit" parameterType="int">
		UPDATE mboard
		SET mboard_hit = mboard_hit + 1
		WHERE mboard_no = #{mBoardNo }
	</update>	
	
	<select id="detailPageByMboardNo" resultType="hashMap" parameterType="int">
		SELECT b.mboard_no, b.mboard_title, b.mboard_content, b.mboard_date, b.mboard_hit, b.mboard_cmtcnt, b.mboard_likecnt, m.member_id, m.member_nick
		FROM mboard b
		JOIN member m ON ( b.member_no = m.member_no )
		WHERE mboard_no = #{mBoardNo }
	</select>
	
	
	<select id=" selectMboardByMboardNo" resultType="hashMap" parameterType="int">
		SELECT b.mboard_no, b.member_no, b.mboard_title, b.mboard_content, b.mboard_hit, b.mboard_cmtcnt, b.mboard_likecnt,
			m.member_id, m.member_nick FROM mboard b
		JOIN member m ON (b.member_no = m.member_no)
		WHERE mboard_no = #{mBoardNo }
	</select>
	
	<!-- 게시글 삽입 -->
	<insert id="insert" parameterType="Mboard">
		<selectKey order="BEFORE" resultType="int" keyProperty="mBoardNo">
			SELECT mboard_seq.nextval FROM dual
		</selectKey>
		INSERT INTO mboard ( mboard_no, member_no, mboard_title, mboard_content, mboard_date, mboard_hit, mboard_cmtcnt, mboard_likecnt)
		VALUES( #{mBoardNo }, #{memberNo }, #{mboardTitle }, #{mboardContent }, sysdate, #{mboardHit }, #{mboardCmtcnt }, #{mboardLikecnt } )
	</insert>
	
	<!-- 파일 삽입 -->
	<insert id="insertFile" parameterType="FileUpload">
		INSERT INTO fileUpload ( fileUpload_no, mBoard_no, fileUpload_ori, fileUpload_stor)
		VALUES ( fileUpload_seq.nextval, #{mBoardNo }, #{fileUploadOri }, #{fileUploadStor })
	</insert>	
	
	<select id="selectMboardFileByMboardNo" resultType="FileUpload" parameterType="Mboard"> 
		SELECT fileUpload_no, mboard_no, fileUpload_ori, fileUpload_stor
		FROM fileUpload
		WHERE mboard_no = #{mBoardNo }
	</select>
	
	<select id="selectMboardFileByFileUploadNo" resultType="dto.FileUpload" parameterType="dto.FileUpload">
		SELECT fileUpload_no, mboard_no, fileUpload_ori, fileUpload_stor
		FROM fileUpload
		WHERE fileUpload_no = #{fileUploadNo }
	</select>
	
	<update id="update" parameterType="dto.Mboard">
		UPDATE mboard
		SET mboard_title = #{mboardTitle },
			mboard_content = #{mboardContent }
		WHERE mboard_no = #{mBoardNo }
	</update>
	
	<!-- 기존 첨부파일 삭제 -->
	<delete id="deleteFile" parameterType="dto.Mboard">
		DELETE fileUpload
		WHERE mboard_no = #{mBoardNo }
	</delete>
	
	<delete id="deleteByMboardNo" parameterType="dto.Mboard">
		DELETE mboard WHERE mBoard_no = #{mBoardNo }
	</delete>
	
	<select id="detailFile" parameterType="dto.Mboard" resultType="dto.FileUpload">
		SELECT fileupload_no, fboard_no, fileupload_ori, fileupload_stor 
		FROM fileupload
		WHERE fileupload_no = #{mBoardNo}
	</select>
	
	<!-- 기존 게시글 삭제 -->
	<delete id="delete" parameterType="dto.Mboard">
		DELETE mboard
		WHERE mboard_no = #{mBoardNo }
	</delete>
	
	<select id="likecount" parameterType="dto.MboardLike" resultType="int">
	 	SELECT count(*) FROM mboardlike
	 	WHERE member_no = #{memberNo }
	 	AND mboard_no = #{mBoardNo }
	</select>
	
	<select id="insertLike" parameterType="dto.MboardLike">
		INSERT INTO mboardlike 
		VALUES ( mboardlike_seq.nextval, #{mBoardNo }, #{memberNo } )
	</select>
	
	<select id="cancelLike" parameterType="dto.MboardLike">
		DELETE mboardlike 
		WHERE study_no = #{mBoardNo }
		AND member_no = #{memberNo }
	</select>
	
	<select id="searchByKeyword" resultType="hashMap" parameterType="hashMap">
		SELECT * FROM mboard
		WHERE 1=1
		<choose>
			<when test="category != null and category.equals('mboard_title')"> 
				AND mboard_title LIKE '%' || #{keyword } || '%'
			</when>		
			
			<when test="category != null and category.equals('mboard_content')"> 
				AND mboard_content LIKE '%' || #{keyword } || '%'
			</when>
			
			<when test="category != null and category.equals('mboard_date')">
				AND mboard_date LIKE '%' || #{keyword } || '%'
			</when>	
		</choose>
	
	</select>
	
	
	

	
	
	

</mapper>
