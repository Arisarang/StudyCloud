<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="dao.face.MntBoardDao">


	<select id="CntBoard" resultType="int" parameterType="map">
		SELECT count(*) FROM (
			SELECT rownum rnum, B.* 
				FROM (
					SELECT n.mntboard_no, m.member_nick, n.field, n.mntboard_title
						, n.mntboard_content , n.mntboard_cmcnt , n.mntboard_hit 
						, n.mntboard_date
						, ( SELECT count(*) FROM mntboardlike ML WHERE N.mntboard_no = ML.mntboard_no ) like_cnt
					FROM mntboard n 
					JOIN member m
					ON ( n.member_no = m.member_no )
					WHERE
						1=1
					<if test="type != null and type != 'tc'">
						AND ${type} like  '%' ||  #{keyword} || '%'
					</if>
					<if test="type == 'tc'">
						AND mntboard_title like '%' ||  #{keyword} || '%'
						OR mntboard_content like '%' ||  #{keyword} || '%'
					</if>
					<if test="field != null">
						AND field = #{field}
					</if>
			 )  B
		) MntBoard
	</select>
	
	 <select id="MntBoardList" resultType="hashmap" parameterType="map">
		SELECT * FROM (
			SELECT rownum rnum, B.* 
				FROM (
					SELECT n.mntboard_no, m.member_nick, n.field, n.mntboard_title
						, n.mntboard_content , n.mntboard_cmcnt , n.mntboard_hit 
						, n.mntboard_date
						, ( SELECT count(*) FROM mntboardlike ML WHERE N.mntboard_no = ML.mntboard_no ) like_cnt
					FROM mntboard n 
					JOIN member m
					ON ( n.member_no = m.member_no )
					WHERE
						1=1
					<if test="type != null and type != 'tc'">
						AND ${type} like  '%' ||  #{keyword} || '%'
					</if>
					<if test="type == 'tc'">
						AND mntboard_title like '%' ||  #{keyword} || '%'
						OR mntboard_content like '%' ||  #{keyword} || '%'
					</if>
					<if test="field != null">
						AND field = #{field}
					</if>
					ORDER BY ${sort} DESC
			 )  B
		) MntBoard
		WHERE rnum BETWEEN #{startNo } AND #{endNo }
	</select>
	
	 <select id="MntBoardListPaging" resultType="hashmap" parameterType="util.PagingVUp">
		SELECT * FROM (
			SELECT rownum rnum, B.* 
				FROM (
					SELECT n.mntboard_no, m.member_nick, n.field, n.mntboard_title
						, n.mntboard_content , n.mntboard_cmcnt , n.mntboard_hit 
						, n.mntboard_date
						, ( SELECT count(*) FROM mntboardlike ML WHERE N.mntboard_no = ML.mntboard_no ) like_cnt
					FROM mntboard n 
					JOIN member m
					ON ( n.member_no = m.member_no )
					ORDER BY mntboard_date DESC
			 )  B
		) MntBoard
		WHERE rnum BETWEEN #{startNo } AND #{endNo }
	</select>

	
	<update id="mntBoardHit" parameterType="int">
		UPDATE mntboard
		SET mntboard_hit = mntboard_hit + 1
		WHERE mntboard_no = #{mntboardNo}
	</update>
	
	
	
	<select id="selectMntBoard" resultType="hashmap" parameterType="int">
		SELECT	 n.mntboard_no,  m.member_nick, m.member_no, n.field, n.mntboard_title, n.mntboard_content 
				, n.mntboard_cmcnt , n.mntboard_hit , n.mntboard_date
				, ( SELECT count(*) FROM mntboardlike ML WHERE N.mntboard_no = ML.mntboard_no ) like_cnt
			FROM mntboard n 
			JOIN member m
			ON (n.member_no = m.member_no)
		WHERE mntboard_no = #{mntboardNo}
	</select>
	
	
	 <insert id="insertBoard" parameterType="dto.MntBoard">
		<selectKey order="BEFORE" resultType="int" keyProperty="mntboardNo">
			SELECT mntboard_seq.nextval FROM dual		
		</selectKey>
		
		INSERT INTO mntboard (
			 mntboard_no, member_no, field, mntboard_title
			, mntboard_content , mntboard_hit , mntboard_date )
	
		VALUES ( #{mntboardNo }, #{memberNo }, #{field }, #{mntboardTitle }
				, #{mntboardContent },  #{mntboardHit } , sysdate )
	</insert>
	
	
	<!-- 파일업로드 dto -->
	<insert id="insertFile" parameterType="dto.FileUpload">
		INSERT INTO fileUpload (
			fileUpload_no, mntboard_no, fileUpload_ori, fileUpload_stor )
		
		VALUES ( fileUpload_seq.nextval, #{mntBoardNo }
				, #{fileUploadOri }, #{fileUploadStor }
		)
	</insert>
	
	
	<select id="selectMntBoardFileByBoardNo" resultType="FileUpload" parameterType="int">
		SELECT fileupload_no, mntboard_no, fileupload_ori, fileupload_stor
		FROM   fileupload
		WHERE  mntboard_no = #{mntboardNo}
	</select>
	
	
	<!-- 파일업로드 dto -->
	<select id="selectBoardFileByFileNo" resultType="FileUpload" parameterType="dto.FileUpload">
		SELECT fileupload_no, mntboard_no, fileupload_ori, fileupload_stor
		FROM   fileupload
		WHERE  fileupload_no = #{fileUploadNo }
	</select>
	
	
	<!-- 게시글 수정 -->
	 <update id="updateMntBoard"  parameterType="dto.MntBoard">
		UPDATE mntboard
		SET	   mntboard_title = #{mntboardTitle}
			 , mntboard_content = #{mntboardContent}
		WHERE mntboard_no = #{mntboardNo}
	</update>
	
	<delete id="deleteFile" parameterType="dto.MntBoard">
		DELETE fileupload
		WHERE mntboard_no = #{mntboardNo}
	</delete>
	
	<delete id="deleteComtByMntBoardNo" parameterType="dto.MntBoard">
		DELETE Commt 
		WHERE mntboard_no = #{mntboardNo}
	</delete>
	
	<delete id="deleteLikeByMntBoardNo" parameterType="dto.MntBoard">
		DELETE mntboardlike 
		WHERE mntboard_no = #{mntboardNo}
	</delete>
	
	<!-- 게시글 삭제 -->
	<delete id="deleteMntBoard" parameterType="dto.MntBoard">
		DELETE mntboard
		WHERE mntboard_no = #{mntboardNo}
	</delete>
	
	
	<!-- 게시판 리스트 제목에 댓글 수  -->
	<update id="mntBoardCmt" parameterType="dto.MntBoard">
		UPDATE mntboard m
		SET m.mntboard_cmcnt = 
		(SELECT COUNT(commt_no) FROM commt WHERE mntboard_no = #{mntboardNo})
		WHERE m.mntboard_no = #{mntboardNo}
	</update>
	
	
	<!-- 게시파 리스트 좋아요수 -->
	<update id="mntBoardLike" parameterType="dto.MntBoard">
		UPDATE mntboard m
		SET m.like_cnt = 
		(SELECT COUNT(mntboardlike_no) FROM mntboardlike WHERE mntboard_no = #{mntboardNo})
		WHERE m.mntboard_no = #{mntboardNo}
	</update>
	

	

	
	
	<!-- 댓글 -->
	
	<select id="CntCommt" parameterType="dto.Commt" resultType="int">
        SELECT count(*) 
        FROM commt
        WHERE mntboard_no = #{mntboardNo}
    </select>
    
    <select id="CommtList" parameterType="hashmap" resultType="hashmap">
        	SELECT * FROM (
            SELECT rownum rnum, C.* FROM(
        	SELECT c.commt_no, c.mntboard_no, m.member_no, m.member_nick, c.commt_content, c.commt_date
            FROM commt c
            JOIN member m
            ON (c.member_no = m.member_no)
            WHERE mntboard_no = #{mntboardNo} AND commt_no > 0  
            ORDER BY commt_no DESC ) C
            ) Commt
			 WHERE rnum BETWEEN #{paging.startNo } AND #{paging.endNo }
    </select>
   
    <insert id="insertCommt" parameterType="dto.Commt">
        INSERT INTO commt(
			commt_no, mntboard_no, member_no, commt_content, commt_date  )
		
		VALUES ( commt_seq.nextval, #{mntBoardNo },  #{memberNo }
				, #{commtContent }, sysdate)
    </insert>

    <select id="selectCmtByCommtNo" parameterType="int" resultType="dto.Commt">
		SELECT commt_no, mntboard_no, member_no, commt_content
		FROM commt 
		WHERE commt_no = #{commtNo}
	</select>
	
    <update id="updateMntCommt" parameterType="dto.Commt">
        UPDATE commt
        SET commt_content = #{commtContent}
          , commt_date = sysdate
        WHERE commt_no = #{commtNo} and member_no = #{memberNo}
    </update> 
	
	
	<delete id="deleteMntCommt" parameterType="dto.Commt">
		DELETE commt 
		WHERE commt_no = #{commtNo}
	</delete>
	
	
	<!-- 좋아요 -->
	<select id="selectCntLike" parameterType="dto.MntBoardLike" resultType="int">
		SELECT count(*)
		FROM mntboardlike
		WHERE mntboard_no = #{mntboardNo}
			AND member_no = #{memberNo }
	</select>
	
	<select id="getTotalCntLike" parameterType="dto.MntBoardLike" resultType="int">
		SELECT count(*)
		FROM mntboardlike
		WHERE member_no = #{memberNo }
	</select>
	
	<delete id="deleteLike" parameterType="dto.MntBoardLike">
		DELETE mntboardlike
		WHERE member_no = #{memberNo }
			AND mntboard_no = #{mntboardNo}
	</delete>
	
	<insert id="insertLike" parameterType="dto.MntBoardLike">
		INSERT INTO mntboardlike (mntboardlike_no, mntboard_no, member_no)
		VALUES (mntboardlike_seq.nextval, #{mntboardNo }, #{memberNo })
	</insert>
	
	
	<select id="getSearchList" parameterType="hashMap" resultType="hashmap">
		SELECT	 n.mntboard_no,  m.member_nick, n.field, n.mntboard_title, n.mntboard_content 
				, n.mntboard_cmcnt , n.mntboard_hit , n.mntboard_date
				, ( SELECT count(*) FROM mntboardlike ML WHERE N.mntboard_no = ML.mntboard_no ) like_cnt
		FROM mntboard n 
		JOIN member m
		ON (n.member_no = m.member_no)
		WHERE
			<foreach collection="list" item="list" separator="AND">
				<choose>
					<when test="list == 'mntBoardTitle'.toString()">
						n.mntboard_title like '%'||#{keyword}||'%'
					</when>
					<when test="list == 'mntBoardContent'.toString()">
						n.mntBoard_content like '%'||#{keyword}||'%'
					</when>
					<when test="list == 'memberNo'.toString()">
						m.member_nick like '%'||#{keyword}||'%'
					</when>
				</choose>
			</foreach>
			ORDER BY mntBoard_no desc ) B
		) mntboard
	WHERE rnum BETWEEN #{startNo} AND #{endNo}	
	</select>
	
	<select id="cntSearchList" resultType="int">
		SELECT count(*) 
		FROM mntboard n
		JOIN  member m
		ON (n.member_no = m.member_no)
		WHERE
		<foreach collection="list" item="list" separator="AND">
			<choose>
				<when test="list == 'mntBoardTitle'.toString()">
					n.mntboard_title like '%'||#{keyword}||'%'
				</when>
				<when test="list == 'mntBoardContent'.toString()">
					n.mntBoard_content like '%'||#{keyword}||'%'
				</when>
				
				<when test="list == 'memberNo'.toString()">
					m.member_nick like '%'||#{keyword}||'%'
				</when>
			</choose>
		</foreach>
	</select>
	
	<select id="getNickByMemberNo" parameterType="int" resultType="String">
		SELECT member_nick 
		FROM member 
		WHERE member_no = #{memberNo}
	</select>
	
	
	
	
</mapper>















